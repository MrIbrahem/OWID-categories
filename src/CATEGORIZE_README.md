# OWID Commons Categorization Module

This directory contains the refactored categorization system for adding categories to OWID files on Wikimedia Commons.

## Directory Structure

```
src/
├── categorize/                    # Core categorization module
│   ├── __init__.py               # Module exports
│   ├── wiki.py                   # Wiki API interactions
│   └── utils.py                  # Helper utilities
├── run_countries.py              # Script for categorizing country files
├── run_continents.py             # Script for categorizing continent files
```

## Module Organization

### categorize/wiki.py
Contains all functions related to Wikimedia Commons API interactions:
- `load_credentials()` - Load bot credentials from .env
- `connect_to_commons()` - Connect and authenticate to Commons
- `add_category_to_page()` - Add a category to a file page
- `ensure_category_exists()` - Create category page if needed
- `get_category_member_count()` - Count files in a category
- `get_page_text()` - Retrieve page content
- `category_exists_on_page()` - Check if category is already added

### categorize/utils.py
Contains helper functions:
- `setup_logging()` - Configure logging system
- `load_json_file()` - Load and parse JSON files
- `normalize_country_name()` - Add "the" prefix to country names
- `build_category_name()` - Generate category names
- `get_parent_category()` - Get parent category for countries/continents

## Usage Scripts

### run_countries.py
Processes country-specific categorization:

```bash
# Process all countries
python run_countries.py

# Dry run (no actual edits)
python run_countries.py --dry-run

# Process first 5 countries only
python run_countries.py --limit 5

# Process 10 files per country
python run_countries.py --files-per-country 10
```

### run_continents.py
Processes continent-specific categorization:

```bash
# Process all continents
python run_continents.py

# Dry run (no actual edits)
python run_continents.py --dry-run

# Process first 2 continents only
python run_continents.py --limit 2

# Process 10 files per continent
python run_continents.py --files-per-continent 10
```

## Categories Created

### Countries
- **Category name format**: `Category:Our World in Data graphs of {Country}`
- **Example**: `Category:Our World in Data graphs of Canada`
- **Parent category**: `Category:Our World in Data graphs by country`
- **Special handling**: Countries like "United Kingdom" become "the United Kingdom"

### Continents
- **Category name format**: `Category:Our World in Data graphs of {Continent}`
- **Example**: `Category:Our World in Data graphs of Africa`
- **Parent category**: `Category:Our World in Data graphs by continent`
- **Supported continents**: Africa, Asia, Europe, North America, South America, Oceania

## Data Sources

### Countries
- **Input directory**: `output/countries/`
- **File format**: `{ISO3}.json` (e.g., `CAN.json`, `USA.json`)
- **Generated by**: Phase 1 (`fetch_commons_files.py`)

### Continents
- **Input directory**: `output/continents/`
- **File format**: `{Continent}.json` (e.g., `Africa.json`, `Asia.json`)
- **Generated by**: Continent data extraction process

## JSON File Structure

### Country JSON
```json
{
  "iso3": "CAN",
  "country": "Canada",
  "graphs": [
    {
      "title": "File:Agriculture share gdp, 1997 to 2021, CAN.svg",
      "indicator": "Agriculture share gdp",
      "start_year": 1997,
      "end_year": 2021,
      "file_page": "https://commons.wikimedia.org/wiki/File:..."
    }
  ],
  "maps": []
}
```

### Continent JSON
```json
{
  "continent": "Africa",
  "graphs": [
    {
      "title": "File:GDP per capita, Africa, 2020.svg",
      "indicator": "GDP per capita",
      "year": 2020,
      "region": "Africa",
      "file_page": "https://commons.wikimedia.org/wiki/File:..."
    }
  ]
}
```

## Logging

Each script creates its own log file:
- Countries: `logs/categorize_countries.log`
- Continents: `logs/categorize_continents.log`

Logs include:
- Connection status
- Processing progress
- Categories added/skipped
- Errors and warnings
- Final statistics

## Rate Limiting

- **Edit delay**: 0.1 seconds between edits
- Prevents API throttling
- Respects Wikimedia's usage policies

## Error Handling

The scripts handle various error conditions:
- Missing credentials
- Connection failures
- Non-existent pages
- Missing JSON fields
- API rate limits

## Migration from Legacy

The original `categorize_commons_files.py` has been refactored into:
1. **wiki.py** - API interaction functions
2. **utils.py** - Helper functions
3. **run_countries.py** - Country processing script
4. **run_continents.py** - Continent processing script (new)

Benefits:
- ✅ Cleaner code organization
- ✅ Easier to maintain and test
- ✅ Support for both countries and continents
- ✅ Better code reuse
- ✅ Simplified testing

## Development

### Running Tests
```bash
# Test module imports
python -c "from categorize import wiki, utils; print('✓ OK')"

# Check syntax
python -m py_compile run_countries.py
python -m py_compile run_continents.py
```

### Adding New Features
1. Add core logic to `wiki.py` or `utils.py`
2. Update exports in `__init__.py`
3. Use in scripts (`run_countries.py` or `run_continents.py`)

## Prerequisites

- Python 3.10+
- Required packages: `mwclient`, `python-dotenv`
- `.env` file with `WM_USERNAME` and `PASSWORD`
- Valid Wikimedia Commons bot credentials

## See Also

- `PHASE2_USAGE.md` - Detailed usage guide
- `plans/plan2.md` - Implementation plan
- `CONTRIBUTING.md` - Contribution guidelines
